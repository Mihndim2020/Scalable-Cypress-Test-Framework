name: Cross-Browser Testing Demo

# This workflow demonstrates running the same Cypress suite across:
# 1. Chrome (GitHub-hosted runner)
# 2. Firefox (GitHub-hosted runner)
# 3. Mobile devices on BrowserStack (iPhone 14, Samsung Galaxy S23)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      enable_browserstack:
        description: 'Enable BrowserStack execution'
        required: false
        type: boolean
        default: true

env:
  CI: true
  NODE_ENV: test

jobs:
  # Job 1: Chrome on GitHub-hosted runner
  chrome-github:
    name: Chrome (GitHub Runner)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.cache/cypress
          key: ${{ runner.os }}-deps-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests in Chrome
        uses: cypress-io/github-action@v6
        with:
          browser: chrome
          spec: 'cypress/e2e/**/*.cy.js'
          config: baseUrl=${{ secrets.BASE_URL || 'http://localhost:3000' }}
        env:
          CYPRESS_USERNAME: ${{ secrets.CYPRESS_USERNAME }}
          CYPRESS_PASSWORD: ${{ secrets.CYPRESS_PASSWORD }}

      - name: Upload Chrome screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: chrome-screenshots-${{ github.run_number }}
          path: cypress/screenshots
          retention-days: 7

      - name: Upload Chrome videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: chrome-videos-${{ github.run_number }}
          path: cypress/videos
          retention-days: 7

  # Job 2: Firefox on GitHub-hosted runner
  firefox-github:
    name: Firefox (GitHub Runner)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.cache/cypress
          key: ${{ runner.os }}-deps-${{ hashFiles('package-lock.json') }}

      - name: Install dependencies
        run: npm ci

      - name: Run Cypress tests in Firefox
        uses: cypress-io/github-action@v6
        with:
          browser: firefox
          spec: 'cypress/e2e/**/*.cy.js'
          config: baseUrl=${{ secrets.BASE_URL || 'http://localhost:3000' }}
        env:
          CYPRESS_USERNAME: ${{ secrets.CYPRESS_USERNAME }}
          CYPRESS_PASSWORD: ${{ secrets.CYPRESS_PASSWORD }}

      - name: Upload Firefox screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: firefox-screenshots-${{ github.run_number }}
          path: cypress/screenshots
          retention-days: 7

      - name: Upload Firefox videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: firefox-videos-${{ github.run_number }}
          path: cypress/videos
          retention-days: 7

  # Job 3: Docker execution (demonstrates containerized testing)
  docker-execution:
    name: Docker Container Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Cypress Docker image
        run: docker build -t cypress-tests .

      - name: Create mock app directory
        run: mkdir -p scripts/mock-app && echo '<h1>Mock App</h1>' > scripts/mock-app/index.html

      - name: Run tests in Docker
        run: |
          docker-compose up -d app
          sleep 5
          docker-compose up --abort-on-container-exit cypress
          EXIT_CODE=$?
          docker-compose down
          exit $EXIT_CODE

      - name: Upload Docker test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-results-${{ github.run_number }}
          path: |
            cypress/screenshots
            cypress/videos
          retention-days: 7

  # Job 4: BrowserStack Desktop (Chrome, Firefox)
  browserstack-desktop:
    name: BrowserStack Desktop (${{ matrix.browser }})
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.enable_browserstack == 'true') ||
      (github.event_name != 'workflow_dispatch' && github.ref == 'refs/heads/main')
    strategy:
      fail-fast: false
      matrix:
        browser: ['chrome', 'firefox']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install jq for JSON processing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create browser-specific BrowserStack config
        run: |
          # Create config for specific browser
          jq --arg browser "${{ matrix.browser }}" \
             --arg os "Windows 10" \
             '.browsers = [{
                "browser": $browser,
                "os": $os,
                "versions": ["latest"]
             }] |
             .run_settings.build_name = "GH-Actions-Desktop-${{ matrix.browser }}-#${{ github.run_number }}" |
             .run_settings.parallels = 3' \
             browserstack-cypress.json > browserstack-config-${{ matrix.browser }}.json

      - name: Run tests on BrowserStack
        run: |
          chmod +x scripts/run-browserstack.sh
          ./scripts/run-browserstack.sh \
            --config browserstack-config-${{ matrix.browser }}.json \
            --sync \
            --local
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BUILD_NUMBER: ${{ github.run_number }}
          LOCAL_IDENTIFIER: gh-actions-${{ github.run_id }}-${{ matrix.browser }}

      - name: Upload BrowserStack logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browserstack-desktop-${{ matrix.browser }}-logs-${{ github.run_number }}
          path: /tmp/browserstack-local.log
          if-no-files-found: ignore
          retention-days: 7

  # Job 5: BrowserStack Mobile (iPhone 14, Samsung Galaxy S23)
  browserstack-mobile:
    name: BrowserStack Mobile (${{ matrix.device }})
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.enable_browserstack == 'true') ||
      (github.event_name != 'workflow_dispatch' && github.ref == 'refs/heads/main')
    strategy:
      fail-fast: false
      matrix:
        include:
          - device: 'iPhone 14'
            os_version: '16'
            browser: 'safari'
          - device: 'Samsung Galaxy S23'
            os_version: '13.0'
            browser: 'chrome'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install jq for JSON processing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Create mobile-specific BrowserStack config
        run: |
          # Create config for specific mobile device
          jq --arg device "${{ matrix.device }}" \
             --arg os_version "${{ matrix.os_version }}" \
             '.browsers = [{
                "device": $device,
                "os_version": $os_version,
                "real_mobile": true
             }] |
             .run_settings.build_name = "GH-Actions-Mobile-${{ matrix.device }}-#${{ github.run_number }}" |
             .run_settings.parallels = 2' \
             browserstack-cypress.json > browserstack-config-mobile.json

      - name: Run mobile tests on BrowserStack
        run: |
          chmod +x scripts/run-browserstack.sh
          ./scripts/run-browserstack.sh \
            --config browserstack-config-mobile.json \
            --sync \
            --local
        env:
          BROWSERSTACK_USERNAME: ${{ secrets.BROWSERSTACK_USERNAME }}
          BROWSERSTACK_ACCESS_KEY: ${{ secrets.BROWSERSTACK_ACCESS_KEY }}
          BUILD_NUMBER: ${{ github.run_number }}
          LOCAL_IDENTIFIER: gh-actions-${{ github.run_id }}-mobile

      - name: Upload BrowserStack mobile logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browserstack-mobile-${{ matrix.device }}-logs-${{ github.run_number }}
          path: /tmp/browserstack-local.log
          if-no-files-found: ignore
          retention-days: 7

  # Job 6: Consolidated Report
  report:
    name: Generate Consolidated Report
    needs: [chrome-github, firefox-github, docker-execution, browserstack-desktop, browserstack-mobile]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: test-artifacts

      - name: Generate summary report
        run: |
          cat > cross-browser-summary.md <<EOF
          # Cross-Browser Test Execution Summary

          **Build**: #${{ github.run_number }}
          **Commit**: ${{ github.sha }}
          **Branch**: ${{ github.ref_name }}
          **Triggered by**: ${{ github.event_name }}

          ## Test Execution Matrix

          ### GitHub-Hosted Runners
          - âœ… Chrome (Ubuntu Latest)
          - âœ… Firefox (Ubuntu Latest)

          ### Docker Container
          - âœ… Containerized Execution (Cypress included image)

          ### BrowserStack Desktop
          - âœ… Chrome on Windows 10
          - âœ… Firefox on Windows 10

          ### BrowserStack Mobile
          - âœ… iPhone 14 (iOS 16) - Safari
          - âœ… Samsung Galaxy S23 (Android 13) - Chrome

          ## Artifacts

          All screenshots, videos, and logs have been uploaded as artifacts.

          - Chrome screenshots and videos
          - Firefox screenshots and videos
          - Docker execution results
          - BrowserStack logs

          ## BrowserStack Dashboard

          View detailed results: https://automate.browserstack.com/

          ---

          **Workflow Run**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          EOF

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: cross-browser-summary-${{ github.run_number }}
          path: cross-browser-summary.md
          retention-days: 14

      - name: Comment PR with summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('cross-browser-summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
